# Докумантация по работе с API PROgulky

### Терминология

*Экскурсия* - объект имеющий название, автора и массив мест (точек на карте).
Является главной сущностью вокруг которой строится всё API.

*Место* - точка на карте, объект, имеющий название и координаты, который можно добавить
к экскурсии
<hr>

## Предметные области API

1. [Авторизация и регистрация](#auth)
2. [Роли](#roles)
3. [Экскурсия и место](#excursion)
4. [Механизм создания экскурсии](#create_excursion)
5. [Картинки](#images)

<hr>

## <a name="auth"></a>Авторизация и регистрация

Для создания экскурсии необходим автор, поэтому создавать экскурсии может только
авторизованный пользователь.
<br>
Просмотр списка всех экскурсий (GET-запрос ```/excursions```) работает без авторизации.

#### Регистрация

Для регистрации пользователя необходимо отправить POST-запрос на ручку
```/auth/registration``` с объектом

```json
{
  "name": "Имя",
  "email": "mail@email.ru",
  "password": "password"
}
```

*Уникальным в базе является имя пользователя ```"name"```, а поэтому создать двух
пользователей с одинаковыми именами не получится.*

После регистрации бэкенд возвращает клиенту объект:

```json
{
  "token": "eyJhbGciOi1NiIsInR5cCIVCJ9-.1i_WC_pfx_kb7ljN4hnVGrrnr2eWB_Tv6AiJ4QHq",
  "name": "Имя",
  "id": 1,
  "email": "mail@mail.ru",
  "role": {
    "id": 2,
    "value": "user",
    "description": "Пользователь"
  }
}
```

С полученным токеном и id пользователь в дальнейшем может посылать запросы на создание
экскурсий и мест.

*Примечание: на данный момент токен не участвует в отправки запросов и доступность
методов никак не ограничена в зависимости от ролей пользователя*

#### Авторизация

Для авторизации пользователя необходимо отправить POST-запрос на ручку
```/auth/login``` с объектом

```json
{
  "name": "Имя",
  "password": "password"
}
```

В ответе вернется полный объект со всеми данными пользователя
(такой же объект что в ответе при регистрации).

**Важно!** На данный момент важно запоминать ```id``` пользователя для отправки
запросов на создание чего либо. Так как создание экскурсий
требует наличие этого идентификатора. В дальнейшем от этого избавимся (всё будет
приходить в токене)

<hr>

## <a name="roles"></a>Роли

***Пока разграничения доступности методов API по ролям нет
(в будущем это будет реализовано).
Прямо сейчас это нужно только для того, чтобы на фронте рисовать зеленую плашку
«от экскурсовода», если экскурсия была создана пользователем в ролью экскурсовод.***

В API заложено три роли:

1. Пользователь
2. Экскурсовод
3. Администратор

Роль **«Пользователь»** получает пользователь при регистрации.

Роль **«Экскурсовод»** получает пользователь по требованию от администрации проекта.
Роль экскурсовод добавляет всем созданным экскурсиям плашку «от экскурсовода».
От этого все созданные экскурсии пользователем под этой ролью становятся более привлекательными.

Роль **«Администратор»** получают администраторы проекта.
Роль должна позволяет удалять/изменять/банить всё и всех.

<hr>

## <a name="excursion"></a>Экскурсия и место

#### Экскурсия (Excursion)

В API есть две фундаментальные сущности, которые должны быть связаны между собой.
Одно из них это Экскурсия.

***Excursion*** - объект имеющий название, автора и массив мест (достопримечательностей),
который описывает цельную стуктуру некоторого собятия, прогулки и т.п.

Объект **Excursion** имеет важные следующие свойства:

1. Заголовок
2. Описание
3. Название картинки
4. OwnerId
5. Значение роли пользователя, который создал экскурсию
6. Places []<br>И др. (cм. Swagger)

***OwnerId*** - идентификатор пользователя, который создаёт экскурсию.
По нему получается свойство owner с объектом создателя.

***Places[]*** - массив объектов мест (точек) экскурсии.

*Пример объекта, который возвращается при GET-запросе по ручке ```/excursions```:*

```json
    {
  "title": "Интересная Москва",
  "description": "Интерересное описание экскурсии",
  "ownerId": 15,
  "ownerRoleValue": "guide",
  "image": "5220-4f26-8f78-67dbc13bd1c0.jpg",
  "rating": 4.91,
  "duration": "2 часа",
  "owner": {
    "id": 15,
    "name": "Семен",
    "email": "user@email.ru"
  },
  "places": []
},
```

#### Место (Place)

***Place*** - объект имеющий название и координаты, который можно добавить
к экскурсии. Это может быть достопримечательность, интересное место и т. д.

Объект *Place* имеет следующие свойства:

1. Название
2. Описание
3. Название картинки
4. Адрес
5. Город
6. Широта точки на карте
7. Долгота точки на карте

*Пример объекта Place:*

```json
{
  "title": "Большой театр",
  "description": "Самый большой театр в стране. Поэтому и называется большой",
  "image": "5220-4f26-8f78-67dbc13bd1c0.jpg",
  "address": "Театральная площадь, 1",
  "city": "Москва",
  "latitude": "55.760452",
  "longitude": "37.618373"
}
```

Объект места создаётся отдельно от экскурсии (отдельным POST-запросом типа ```multipart/form-data```).
Для создания места нужно передать необходимые параметры и картинку места в POST-запросе с типом ```multipart/form-data```,
где картинка передается как File, а все остальное как Text.

Место никак не связывается с пользователем, который создаёт это место.
То есть у созданного места нет автора (это стоит помнить).

После создания места, бэкенд возвращает ```id``` этого созданного места, которое необходимо запоминать
на фронте, чтобы потом создать экскурсию с этим местом.

<hr>

## <a name="create_excursion"></a>Механизм создания экскурсии

Создание экскурсии происходит через метод```/excursions``` POST-запросом.
Чтобы создать экскурсию нужно приготовить все необходимые поля.

Тело запроса на создание экскурсии надо создавать в соотвествии с типом  ```multipart/form-data```

**Поля multipart/form-data тела POST-запроса на создание экскурсии**

| Название параметра | Описание параметра                                                                |
|--------------------|:----------------------------------------------------------------------------------|
| title (Text)       | Заголовок экскурсии                                                               |
| description (Text) | Описание экскурсии                                                                |
| ownerId (Text)     | Id пользователя, который создает экскурсию                                        |
| image (File)       | Файл картинки                                                                     |
| duration (Text)    | Продолжительность экскурсии                                                       |
| placesIds (Text)   | Строка id-шников мест, которые относятся к этой экскурсии (в порядке на маршруте) |

*Примечания*: 
<br>
в ***ownerId*** нужно класть id именно как Int!
<br>
в ***placesIds*** нужно класть именно СТРОКУ из айдишников мест через запятую, которые надо прикрепить к этой экскурсии, в том порядке,
в котором эти места идут в маршруте!
<br>

**Вывод**
<br>
Экскурсия создается одним POST-запросом c multipart/form-data, в котором присваиваются все места этой экскурсии,
путем передачи id-шников этих мест. Id-шники передаются строкой через запятую.
<br>
Файл прикрепляется в поле image, как File.


## <a name="images"></a>Картинки

В объектах Excursion() и Place() в GET-запросе в свойстве ```"image"``` находится название с которым
картинка сохранилась на диск. Картинки экскурсий и картинки мест сохраняются по разным путям.

Картинку можно получить:
<br>
1. Для Excursion -> ```/images/excursions/<image_name.jpg>```
2. Для Place -> ```/images/places/<image_name.jpg>```

<hr>

*Последнее обновление: 02.11.2022*